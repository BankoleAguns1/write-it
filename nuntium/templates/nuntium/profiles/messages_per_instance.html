{% extends "base_manager.html" %}
{% load i18n %}
{% load subdomainurls %}
{% load staticfiles %}
{% load pagination_tags %}
{% block extrajs %}
{% endblock extrajs %}
{% load nuntium_tags %}






{% block header %}

{% include 'nuntium/profiles/per_instance_top_menu.html' with section='messages_per_writeitinstance' %}

{% endblock header %}

{% block content %}
  <div class="page-header">
    <h2>{% trans "Messages" %}</h2>
  </div>
  <div class="manager-overview">
    {% blocktrans count message_count=writeitinstance.message_set.count %}
    <strong>1</strong> message in your WriteIt
    {% plural %}
    There are <strong>{{ message_count }}</strong> messages in your WriteIt
    {% endblocktrans %}
  </div>
    {% autopaginate message_list %}
      {% paginate %}
      <table class="table table-striped">
        <thead>
          <tr>
            <th>{% trans "Message" %}</th>
            <th class="text-center">{% trans "Public" %}</th>
            <th class="text-center">{% trans "Confirmed" %}</th>
            {% if writeitinstance.config.moderation_needed_in_all_messages %}
            	<th class="text-center">{% trans "Moderated" %}</th>
            {% endif %}
            <th class="text-center">{% trans "Answers"%}</th>
            <th class="text-center">{% trans "Delete"%}</th>
          </tr>
        </thead>
        <tbody>
          {% for message in message_list %}
          <tr class="message-in-message-list">
            <td>
              <h3><a href="{% url 'message_detail_private' subdomain=writeitinstance.slug pk=message.pk %}">{{ message.subject }}</a></h3>
              <p class="message-in-message-list__meta">
                {% blocktrans with created=message.created|timesince author_name=message.author_name to=message.people|join_with_commas %}
                  Sent <strong>{{ created }}</strong> ago to <strong>{{ to }}</strong> from <strong>{{ author_name }}</strong>
                {% endblocktrans %}
              </p>
            </td>
            <td class="text-center">
              {% if message.public %}
              <div class="explanation" data-toggle="tooltip" data-placement="left" title="{% trans 'This message can be seen by everyone' %}">
                <i class="glyphicon glyphicon-ok"></i>
              </div>
              {% endif %}
            </td>
            <td class="text-center">
            {% if message.confirmated %}
              <div class="explanation"  data-toggle="tooltip" data-placement="left" title="{% trans 'The author has confirmed that this was sent from their email' %}">
                <i class="glyphicon glyphicon-ok"></i>
              </div>
            {% endif %}
            </td>
            {% if writeitinstance.config.moderation_needed_in_all_messages %}
              {% if message.moderated %}
              <td class="text-center">
                <div class="explanation"  data-toggle="tooltip" data-placement="left" title="{% trans 'This message has been moderated' %}"><i class="glyphicon glyphicon-ok"></i></div>
              </td>
              {% else %}
              <td class="text-center">
                <div class="explanation"  data-toggle="tooltip" data-placement="left" title="{% trans 'This message has not been moderated and you can moderate it by clicking here' %}"><i class="fa fa-times-circle-o"></i> <a class="btn btn-default btn-sm moderate" href="{% url 'accept_message' pk=message.pk %}">{% trans "Moderate"%}</a>
                </div>
              </td>
              {% endif %}

            {% endif %}

            <td class="text-center">
              {{ message.answers.count  }}
              {% if writeitinstance.config.can_create_answer %}
                <a data-toggle="modal" data-target="#modal" href="{% url 'create_answer' subdomain=writeitinstance.slug pk=message.pk %}" alt="{% trans "Add"%}"><i class="fa fa-plus"></i></a>
              {% endif %}
            </td>
            <td class="text-center">
              <a data-toggle="modal" data-target="#modal" class="deleteMessage" href="{% url 'message_delete' subdomain=writeitinstance.slug pk=message.pk %}"><i class="fa fa-times"></i></a>
            </td>

          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-center">{% trans "You have no messages" %}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      {% paginate %}

<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
     <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">{% trans "Delete this message?"%}</h4>
      </div>
      <div class="modal-body">
        <p>{% trans "Are you sure you want to delete this message? This can't be undone."%}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "No, keep it"%}</button>
        <button type="button" class="btn btn-primary">{% trans "Yes, delete it"%}</button>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
$('.explanation').tooltip({})
var postToUrlAndReload = function(event){
  event.preventDefault();
  var url = $(event.target).attr('href');
  $.post(url, function(data){
    location.reload();
  })
}
$(function(){
  $('.moderate').click(postToUrlAndReload)
  $('.toggle-public').click(postToUrlAndReload)
})

</script>
{% endblock content %}
